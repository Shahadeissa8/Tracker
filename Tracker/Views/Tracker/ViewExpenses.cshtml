@model SearchViewModel
@{
    ViewData["Title"] = "View Expenses";
}

<!-- Stylesheets -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
@* <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" rel="stylesheet"> *@
<link href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css" rel="stylesheet">

 <!-- Main Content -->
<div class="container mt-5">
    @* <div class="alert alert-info text-center mt-4"> *@
    @*     <strong>Remaining Budget:</strong> @Model.Amount *@
    @* </div> *@

    <div class="mb-4 d-none">
        <input class="form-control d-none" id="myInput" type="text" placeholder="Search expenses...">
    </div>

    <div class="card card-custom mb-4 d-none">
        <div class="card-body">
            <div class="table-responsive">
                <table id="myTable" class="table table-striped table-hover table-bordered">
                    <thead class="bg-bank-primary">
                        <tr>
                            <th>Name of Expense</th>
                            <th>Expense Amount</th>
                            <th>Currency</th>
                            <th>Expense Date</th>
                            <th>Expense Description</th>
                            <th>Expense Recurrence</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ExpensesList != null && Model.ExpensesList.Any())
                        {
                            @foreach (var expense in Model.ExpensesList)
                            {
                                <tr>
                                    <td>@expense.ExpenseName</td>
                                    <td><span id="amount-@expense.ExpenseId">@expense.ExpenseAmount</span></td>
                                    <td>
                                        <select class="form-control currency-select" data-id="@expense.ExpenseId" data-amount="@expense.ExpenseAmount">
                                            <option value="0">select</option>
                                            <option value="1">USD</option>
                                            <option value="0.3">KWD</option>
                                            <option value="3.67">AED</option>
                                        </select>
                                    </td>
                                    <td>@expense.ExpenseDate.ToString("yyyy-MM-dd")</td>
                                    <td>@expense.ExpenseDescription</td>
                                    <td>@expense.Recurring</td>
                                    <td>
                                        <form method="post" asp-action="Delete" asp-route-expenseId="@expense.ExpenseId" asp-controller="Tracker" onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                            <button type="submit" class="btn btn-danger">Delete</button>
                                        </form>
                                    </td>

                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted">No expenses found.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card card-custom">
        <div class="card-body">
            <div class="table-responsive">
                <table id="example" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name of Expense</th>
                            <th>Expense Amount</th>
                            <th>Currency Convert</th>
                            <th>Expense Date</th>
                            <th>Expense Description</th>
                            <th>Expense Recurrence</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ExpensesList != null && Model.ExpensesList.Any())
                        {
                            int indx = 1;
                            @foreach (var expense in Model.ExpensesList)
                            {
                                <tr>
                                    <td>@expense.ExpenseName</td>
                                    <td>
                                        <span id="amount-@expense.ExpenseId">@expense.ExpenseAmount</span>
                                        <span class="badge bg-secondary">@expense.Curency</span>
                                    </td>
                                    <td>
                                        <span id="amt-@indx"></span>
                                        <select class="form-control-sm currency-select" data-id="amt-@indx" data-amount="@expense.ExpenseAmount" data-currency="@expense.Curency" id="currency-select-@indx">
                                            <option value="0">select</option>
                                            <option value="1">USD</option>
                                            <option value="0.3">KWD</option>
                                            <option value="3.67">AED</option>
                                        </select>
                                    </td>
                                    <td>@expense.ExpenseDate.ToString("yyyy-MM-dd")</td>
                                    <td>@expense.ExpenseDescription</td>
                                    <td>@expense.Recurring</td>
                                    <td>
                                        <form method="post" asp-action="Delete" asp-route-expenseId="@expense.ExpenseId" asp-controller="Tracker" onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                            <button type="submit" class="btn btn-danger">Delete</button>
                                        </form>
                                    </td>

                                </tr>
                                indx++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted">No expenses found.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-4">
    <a asp-action="Index" asp-controller="Home" class="btn btn-lg btn-outline-primary">Back to Home</a>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>

<script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>
<script>


    $(document).ready(function () {

        new DataTable('#example');

        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#myTable tbody tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // $(".currency-select").on("change", function () {
        //     var selectedRate = $(this).val();
        //     var expenseId = $(this).data("id");
        //     var originalAmount = $(this).data("amount");
        //     var convertedAmount = (originalAmount * selectedRate).toFixed(2);
        //     $("#amount-" + expenseId).text(convertedAmount);
        // });

        // Handle change event for the currency-select dropdown
        $('.currency-select').on('change', function () {
            debugger;
            var selectedCurrency = $(this).val(); // Get selected currency value
            var expenseId = $(this).data('id'); // Get the expense ID
            var amount = $(this).data('amount'); // Get the expense amount
            var currentCurrency = $(this).data('currency'); // Get current currency (from data attribute)

            // Calculate the new amount based on selected currency
            var convertedAmount = amount;

            if (currentCurrency === 'USD' && selectedCurrency === '0.3') {
                convertedAmount = amount * 0.3; // USD to KWD
            } else if (currentCurrency === 'USD' && selectedCurrency === '3.67') {
                convertedAmount = amount * 3.67; // USD to AED
            } else if (currentCurrency === 'KD' && selectedCurrency === '1') {
                convertedAmount = amount / 0.3; // KWD to USD
            } else if (currentCurrency === 'KD' && selectedCurrency === '3.67') {
                convertedAmount = amount * 3.67 / 0.3; // KWD to AED
            } else if (currentCurrency === 'AED' && selectedCurrency === '1') {
                convertedAmount = amount / 3.67; // AED to USD
            } else if (currentCurrency === 'AED' && selectedCurrency === '0.3') {
                convertedAmount = amount / 3.67 * 0.3; // AED to KWD
            }

            // Update the amount text with the converted amount
            $('#' + expenseId).text(convertedAmount.toFixed(2));
            $('#currency-select-' + expenseId).closest('tr').find('.badge.bg-secondary').text(selectedCurrency === '1' ? 'USD' : (selectedCurrency === '0.3' ? 'KWD' : 'AED'));
        });

    });
</script>